{% extends "modeladmin/inspect.html" %}
{% load i18n modeladmin_tags wagtailadmin_tags wagtailcore_tags %}

{% block fields_output %}
    {% if fields %}
        <h3>{% trans "Details" %}</h3>
        <dl>
            {% for field in fields %}
                <dt class="{{ field.type|lower }}">{{ field.label }}</dt>
                <dd>
                    {% if field.value.files %}
                        <ul>
                            {% for fi in field.value.files %}
                                <li>{{ fi }}</li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        {{ field.value }}
                    {% endif %}
                </dd>
            {% endfor %}
        </dl>
    {% endif %}
{% endblock %}

{% block content %}
    {{ block.super }}

    {% if category != 'generated-by-the-system' %}

    <div class="nice-padding">
        <h3>{% trans "Reports" %}</h3>
        <table class="listing">
            <thead>
                <tr>
                    <th>{% trans 'Name' %}</th>
                    <th>{% trans 'Date' %}</th>
                    <th>{% trans 'Errors' %}</th>
                    <th>{% trans 'Link' %}</th>
                </tr>
            </thead>
            <tbody>
                {% for report in reports %}
                    <tr>
                        <td class='title'>{{ report.title }}</td>
                        <td>{{ report.updated }}</td>
                        <td>{{ report.errors }}</td>
                        <td>

                            {% if report.creation == 'doing' %}
                                <a class="report-link" href="">{% trans 'Processing...' %}</a>
                            {% else %}
                                <a class="report-link" href="/admin/upload/validationreport/edit/{{ report.id }}">
                                    {% if perms.upload.send_validation_error_resolution and report.errors %}
                                        {% trans 'Resolve errors' %}
                                    {% else %}
                                        {% trans 'View report' %}
                                    {% endif %}
                                </a>  
                            {% endif %}                      
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    
        <table class="listing">
            <thead>
                <tr>
                    <th>{% trans 'Name' %}</th>
                    <th>{% trans 'Date' %}</th>
                    <th>{% trans 'Errors' %}</th>
                    <th>{% trans 'Errors to fix' %}</th>
                    <th>{% trans 'Errors of absent data' %}</th>
                    <th>{% trans 'Errors not to fix' %}</th>
                    <th>{% trans 'Link' %}</th>
                </tr>
            </thead>
            <tbody>
                {% for report in xml_error_reports %}
                    <tr>
                        <td class="title">{{ report.title }}</td>
                        <td>{{ report.updated }}</td>
                        <td>{{ report.errors }}</td>
                        <td>{{ report.reaction_to_fix }}</td>
                        <td>{{ report.reaction_absent_data }}</td>
                        <td>{{ report.reaction_not_to_fix }}</td>
                        <td>
                            <a name="xer{{ report.id }}"/>
                            {% if report.creation == 'doing' %}
                                <a class="report-link" href="#xer{{ report.id }}">{% trans 'Processing... Reload page' %}</a>
                            {% elif perms.upload.send_validation_error_resolution %}
                                <a class="report-link" href="/admin/upload/xmlerrorreport/edit/{{ report.id }}">
                                    {% trans 'Review errors' %}
                                    {% if report.xml_producer_ack %}
                                        ({% trans 'done' %})
                                    {% else %}
                                        ({% trans 'pending' %})
                                    {% endif %}
                                </a>
                            {% elif perms.upload.analyse_validation_error_resolution %}
                                <a class="report-link" href="/admin/upload/xmlerrorreport/inspect/{{ report.id }}">
                                    {% if report.xml_producer_ack %}
                                        {% trans 'Analyse XML producer responses' %}
                                    {% else %}
                                        {% trans 'Analyse errors' %}
                                    {% endif %}
                                </a>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <table class="listing">
            <thead>
                <tr>
                    <th>{% trans 'Name' %}</th>
                    <th>{% trans 'Date' %}</th>
                    <th>{% trans 'Validations' %}</th>
                    <th>{% trans 'Link' %}</th>
                </tr>
            </thead>
            <tbody>
                {% for report in xml_info_reports %}
                    <tr>
                        <td class='title'>{{ report.title }}</td>
                        <td>{{ report.updated }}</td>
                        <td>{{ report.count }}</td>    
                        <td>
                            <a class="report-link" href="/admin/upload/xmlinforeport/edit/{{ report.id }}">{% trans 'View report' %}</a>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% if perms.upload.send_validation_error_resolution or perms.upload.analyse_validation_error_resolution %}
        {% if not summary.is_validation_finished %}
            <a name="bottom"/>
            <div class="nice-padding row">
                <a class="report-link" href="#bottom">
                    {% trans 'Processing validations... Reload page. ' %}
                </a>
            </div>
        {% else %}
            <div class="nice-padding row">
                <p>{% trans 'Validations finished!' %}</p>
            </div>
            <div class="nice-padding row">
                <h3>{% trans "Summary" %}</h3>

                <div class="row">
                    <div class="12">
                        <ul>
                            <li>{% trans "Warnings" %}: {{ summary.warnings }} / {{ summary.validations }}</li>
                            <li>{% trans "Errors" %}: {{ summary.errors }} / {{ summary.validations }}</li>
                            <li>{% trans "Blocking errors" %}: {{ summary.blocking_errors }} / {{ summary.validations }}</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="nice-padding row">
                <h3>{% trans "Actions" %}</h3>
                <div class="row">
                    <div class="12">

                    {% if status == 'pending-correction' or status == 'rejected' %}
                        <div class="help-block help-critical"><svg class="icon icon-critical icon" aria-hidden="true"><use href="#icon-critical"></use></svg>
                            <a class="report-link" href="{% url 'upload:download_errors' %}?package_id={{ package_id }}">
                                <!-- User must finish the error review -->
                                {% trans 'The XML producer must correct the errors, then submit the corrected package' %}
                            </a>
                        </div>
                    {% elif perms.upload.send_validation_error_resolution and status == 'pending-deposit' %}
                        {% if summary.xml_errors_to_fix %}
                            
                            {% if not summary.is_error_review_finished %}
                                <a class="report-link" href="?#xer2">
                                    <!-- User must finish the error review -->
                                    {% trans 'Review and comment the errors' %}
                                </a>
                            {% endif %}

                            <a class="report-link" href="{% url 'upload:download_errors' %}?package_id={{ package_id }}">
                                <!-- User must finish the error review -->
                                {% trans 'The XML producer must correct the errors, then submit the corrected package' %}
                            </a>

                        {% elif summary.xml_errors_not_to_fix or summary.xml_errors_absent_data %}
                            {% if summary.is_error_review_finished and summary.is_acceptable_package %}
                                <!-- a class="report-link" href="{% url 'upload:finish_deposit' %}?package_id={{ package_id }}" -->
                                <div class="help-block help-warning"><svg class="icon icon-warning icon" aria-hidden="true"><use href="#icon-warning"></use></svg>
                                    {% if summary.xml_errors_not_to_fix %}
                                        {% trans 'The XML producer concluded that' %} {{ summary.xml_errors_not_to_fix }} {% trans 'are not errors ' %}.
                                    {% endif %}
                                </div>
                                <div class="help-block help-warning"><svg class="icon icon-warning icon" aria-hidden="true"><use href="#icon-warning"></use></svg>
                                    {% if summary.xml_errors_absent_data %}
                                        {% trans 'The XML producer concluded that' %} {{ summary.xml_errors_absent_data }} {% trans 'are errors caused by absent data' %}.
                                    {% endif %}
                                </div>
                            {% elif summary.is_error_review_finished %}
                                <!-- not allowed to finish deposit with errors -->
                                <div class="help-block help-critical"><svg class="icon icon-critical icon" aria-hidden="true"><use href="#icon-critical"></use></svg>
                                    {% trans 'The XML producer must correct the package and submit again' %}
                                    <a class="report-link" href="{% url 'upload:download_errors' %}?package_id={{ package_id }}">
                                        <!-- User must finish the error review -->
                                        {% trans 'The XML producer must correct the errors, then submit the corrected package' %}
                                    </a>
                                </div>
                            {% else %}
                                <a class="report-link" href="?#xer2">
                                    <!-- User must finish the error review -->
                                    {% trans 'Review and comment the errors' %}
                                </a>
                            {% endif %}
                        
                        {% else %}
                            <div class="help-block help-info"><svg class="icon icon-help icon" aria-hidden="true"><use href="#icon-help"></use></svg>
                              {% trans 'Finish deposit' %}
                            </div>
                        {% endif %}
                    {% elif perms.upload.analyse_validation_error_resolution %}
                        {% if status == 'pending-qa-decision' %}
                            <div class="help-block help-info"><svg class="icon icon-help icon" aria-hidden="true"><use href="#icon-help"></use></svg>
                                {% trans 'The XML producer reviewed the errors and commented them' %}
                            </div>
                            <div class="help-block help-info"><svg class="icon icon-help icon" aria-hidden="true"><use href="#icon-help"></use></svg>
                                {% trans 'Assign quality analysis and/or Add quality analysis conclusion' %}
                            </div>

                        {% elif status == 'validated-with-errors' %}
                            <div class="help-block help-warning"><svg class="icon icon-warning icon" aria-hidden="true"><use href="#icon-warning"></use></svg>
                                {% trans 'The XML producer should review and comment the errors, but exceptionally the quality analyst is allowed to reject or accept the package with errors before XML producer finishes the review' %}
                            </div>
                        {% endif %}
                        
                    {% else %}
                        <div class="help-block help-warning"><svg class="icon icon-warning icon" aria-hidden="true"><use href="#icon-warning"></use></svg>
                            {% trans '{{ status }}' %}
                        </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

        </div>
        <div class="nice-padding row">
            <div>...........</div>
        </div>

    {% endif %}
{% endblock %}